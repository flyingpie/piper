@using Blazor.Diagrams.Components
@using Blazor.Diagrams.Components.Widgets
@using Piper.Core
@using Piper.UI.Components.CodeEditor
@using Piper.UI.Components.Logs
@using Piper.UI.Components.Nodes
@using Piper.UI.Services

@inject ContextMenuService ContextMenuService

@code {

	private record NodeEntry(string Icon, string Name, string Code);

	private readonly List<NodeEntry> _nodes =
	[
		new("fa-regular fa-folder",			"List Files",		"PP_NODE_LIST_FILES"),
		new("fa-regular fa-file-lines",		"Read Files",		"PP_NODE_READ_FILES"),
		new("fa-solid fa-database",			"Execute Query",	"PP_NODE_QUERY"),
		new("fa-regular fa-file-lines",		"Read CSV",			"PP_NODE_READ_CSV"),
		new("fa-regular fa-file-lines",		"Read XSLX",		"PP_NODE_READ_XSLX"),
		new("fa-regular fa-file-lines",		"List SMAP",		"PP_NODE_SMAP"),
		new("fa-regular fa-database",		"RDBMS Query",		"PP_NODE_RDBMS"),
		new("fa-regular fa-code",			"Script",			"PP_NODE_SCRIPT"),
		new("fa-regular fa-code",			"Function",			"PP_NODE_FUNCTION"),
	];

	void ShowContextMenuWithContent(MouseEventArgs args) => ContextMenuService.Open(
		args,
		ds =>
			@<RadzenMenu Click="a => OnMenuItemClick(args, a)" class="font-awesome">
				<RadzenMenuItem Icon="add_ad"				Text="Add Node..."		Value="@("CHILD")">

					@foreach (var node in _nodes)
					{
						<RadzenMenuItem Value="@node.Code">
							<Template>
								<span class="@node.Icon" style="width: 1.5em;"></span>
								<span>@node.Name</span>
							</Template>
						</RadzenMenuItem>
					}

				</RadzenMenuItem>

				<RadzenMenuItem Text="Fit"				Click="() => Diagram.ZoomToFit()"></RadzenMenuItem>

			</RadzenMenu>);

}

<RadzenSplitter
	Orientation="Orientation.Vertical"
	style="border: 1px solid rgba(0,0,0,.08); position: absolute; top: 0; right: 0; bottom: 0; left: 0;"
>
	<RadzenSplitterPane Size="70%">

		<RadzenSplitter Orientation="Orientation.Horizontal">
			<RadzenSplitterPane Size="80%">

				@* <RadzenStack Style="height: 100%;"> *@

					@* <RadzenPanelMenu> *@
					@* 	<RadzenPanelMenuItem Text="Bleh" /> *@
					@* </RadzenPanelMenu> *@

					<div
						class="diagram-container"
						@oncontextmenu=@(args => ShowContextMenuWithContent(args))
						@oncontextmenu:preventDefault="true"
					>
						<CascadingValue Value="Diagram" IsFixed="true">
							<DiagramCanvas>
								<Widgets>
									<GridWidget
										Mode="GridMode.Point"
										BackgroundColor="var(--rz-base-900)"
									/>
								</Widgets>
							</DiagramCanvas>
						</CascadingValue>
					</div>

				@* </RadzenStack> *@

			</RadzenSplitterPane>
			<RadzenSplitterPane>

				<RadzenTabs Style="height: 100%;">
					<Tabs>

						<!-- Graphs -->
						<RadzenTabsItem Text="Graphs" Icon="polyline">

							<RadzenStack Style="height: 100%;">

								<RadzenSplitter Orientation="Orientation.Vertical">
									<RadzenSplitterPane>

										<RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Stretch">

											<RadzenStack Orientation="Orientation.Horizontal">
												<RadzenTextBox Style="flex: 1;" />
												<RadzenButton Text="Save As" Size="ButtonSize.Small" />
											</RadzenStack>

											@*
											<RadzenTable>
												<RadzenTableBody>

													@foreach (var graphFile in Graphs)
													{
														<RadzenTableRow>
															<RadzenTableCell Style="width: 80px;">
																<RadzenStack Orientation="Orientation.Horizontal" Gap="1em">
																	<RadzenButton Icon="file_open" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.ExtraSmall" Click="() => LoadGraphFile(graphFile)" />
																	<RadzenButton Icon="save" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" Click="() => SaveGraphFile(graphFile)" />
																</RadzenStack>
															</RadzenTableCell>
															<RadzenTableCell>@graphFile.Name</RadzenTableCell>
														</RadzenTableRow>
													}

												</RadzenTableBody>
											</RadzenTable>
											*@

											<RadzenDataGrid
												Data="@Graphs"
											>
												<Columns>
													<RadzenDataGridColumn
														Title="Name"
														Property="@nameof(PpGraphFile.Name)"
													/>

													<RadzenDataGridColumn Width="180px">
														<Template Context="graphFile">

															<RadzenStack Orientation="Orientation.Horizontal">
																<RadzenButton Icon="folder_open" Text="Load" Variant="Variant.Outlined" Size="ButtonSize.Small" Click="() => LoadGraphFile(graphFile)" />
																<RadzenButton Icon="save" Text="Save" Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="() => SaveGraphFile(graphFile)" />
															</RadzenStack>

														</Template>
													</RadzenDataGridColumn>
												</Columns>
											</RadzenDataGrid>

										</RadzenStack>

									</RadzenSplitterPane>

									<RadzenSplitterPane>
										SUP
									</RadzenSplitterPane>

								</RadzenSplitter>


							</RadzenStack>


						</RadzenTabsItem>
						<RadzenTabsItem Text="Node" Icon="toolbar">
							@if (SelectedNode != null)
							{
								@(SelectedNode?.NodeType)

								foreach (var prop in SelectedNode!.NodeProps)
								{
									if (prop is Core.PpNodeParam param)
									{
										<PpNodeParam Param="param" IsInNode="false" />
									}

									@* else if (prop is Core.PpNodePort port) *@
									@* { *@
									@* 	<PpNodePort NodePort="port"/> *@
									@* } *@
								}
							}

						</RadzenTabsItem>

						@* <!-- Tables --> *@
						@* <RadzenTabsItem Text="Tables" Icon="table_view"> *@
						@* *@
						@* 		<RadzenDataGrid *@
						@* 			Data="@Tables" *@
						@* 		> *@
						@* 			<Columns> *@
						@* 				<RadzenDataGridColumn *@
						@* 					Title="Name" *@
						@* 					Property="@nameof(PpTable.TableName)" *@
						@* 				/> *@
						@* *@
						@* 				<RadzenDataGridColumn Width="180px"> *@
						@* 					<Template Context="graphFile"> *@
						@* *@
						@* 						<RadzenStack Orientation="Orientation.Horizontal"> *@
						@* 							$1$ <RadzenButton Icon="folder_open" Text="Load" Variant="Variant.Outlined" Size="ButtonSize.Small" Click="() => LoadGraphFile(graphFile)" /> #1# *@
						@* 							$1$ <RadzenButton Icon="save" Text="Save" Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="() => SaveGraphFile(graphFile)" /> #1# *@
						@* 						</RadzenStack> *@
						@* *@
						@* 					</Template> *@
						@* 				</RadzenDataGridColumn> *@
						@* 			</Columns> *@
						@* 		</RadzenDataGrid> *@
						@* *@
						@* </RadzenTabsItem> *@


						<!-- Modifiers -->
						<RadzenTabsItem Text="Modifiers" Icon="polyline">

							<RadzenStack>

								<RadzenMenu Click="a => AddModifier(a.Value?.ToString())">
									<RadzenMenuItem Text="Add">
										<RadzenMenuItem Text="Casing" Value="@("PP_MOD_CASING")" />
										<RadzenMenuItem Text="Reverse" Value="@("PP_MOD_REVERSE")" />
									</RadzenMenuItem>
								</RadzenMenu>

								<RadzenTable>
									<RadzenTableBody>

										@foreach (var mod in SelectedThingyService.Instance?.SelectedTable?.Modifiers ?? [])
										{
											<RadzenTableRow>
												<RadzenTableCell>@mod.Name</RadzenTableCell>
												<RadzenTableCell Style="width: 7em;">
													<RadzenButton
														Icon="keyboard_arrow_up" Size="ButtonSize.ExtraSmall" Variant="Variant.Outlined" />
													<RadzenButton
														Icon="keyboard_arrow_down" Size="ButtonSize.ExtraSmall" Variant="Variant.Outlined" />
													<RadzenButton
														Click="() => RemoveModifier(mod)"
														Text="X" Size="ButtonSize.ExtraSmall" Variant="Variant.Outlined" />
												</RadzenTableCell>
											</RadzenTableRow>
										}
									</RadzenTableBody>
								</RadzenTable>

							</RadzenStack>

						</RadzenTabsItem>
					</Tabs>
				</RadzenTabs>

			</RadzenSplitterPane>
		</RadzenSplitter>

	</RadzenSplitterPane>
	<RadzenSplitterPane>

		<RadzenTabs TabPosition="TabPosition.Top" Style="height: 100%;">
			<Tabs>
				<RadzenTabsItem Text="Data" Icon="table">
					<DataViewer/>
				</RadzenTabsItem>
				<RadzenTabsItem Text="Code" Style="height: 100%;" Icon="code">
					<RadzenStack Orientation="Orientation.Vertical" Style="height: 100%;" Gap=".5em">
						<RadzenMenu>
							<RadzenMenuItem Text="File"/>
						</RadzenMenu>
						<PpCodeEditor/>
					</RadzenStack>
				</RadzenTabsItem>
				<RadzenTabsItem Text="Logs" Icon="graph_2">
					<LogsPanel />
				</RadzenTabsItem>
			</Tabs>
		</RadzenTabs>

	</RadzenSplitterPane>
</RadzenSplitter>


<style>
	.diagram-container {
		width: 100%;
		height: 100%;
		border: 1px solid black; /* Just visual */
	}

	.default-node {
		background-color: var(--rz-secondary-darker);
		border: 1px solid var(--rz-base-600);
		border-radius: 0.25em;
		color: var(--rz-base-50);
	}

	.default-node.selected {
		border: 1px solid var(--rz-base-400);
	}

	.default-node .diagram-port {
		width: 12px;
		height: 12px;
		margin: -6px;
	}

	.rz-tabview-panel {
		height: 100%;
		padding: .5em;
	}
</style>